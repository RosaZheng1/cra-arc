<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Option Taxable Benefit Calculator</title>
  <style>
     .result {
        display: none; /* Hide results initially */
     }
  </style>
</head>
<body>
  <h2>Stock Option Taxable Benefit Calculator</h2>

  <h3>Situation 1 (Before June 25, 2024)</h3>
  <label for="grantPrice1">Grant Price per Share ($):</label>
  <input type="number" id="grantPrice1" step="0.01"><br><br>

  <label for="exercisePrice1">Exercise Price per Share ($):</label>
  <input type="number" id="exercisePrice1" step="0.01"><br><br>

  <label for="fmvAtExercise1">Fair Market Value at Exercise ($):</label>
  <input type="number" id="fmvAtExercise1" step="0.01"><br><br>

  <label for="numberOfShares1">Number of Shares:</label>
  <input type="number" id="numberOfShares1"><br><br>

  <label for="employeeContribution1">Employee Contribution ($):</label>
  <input type="number" id="employeeContribution1" step="0.01" value=""><br><br>

  <label for="exerciseDate1">Exercise Date:</label>
  <input type="date" id="exerciseDate1" min="2024-01-01" max="2024-06-25"><br><br>

  <h3>Situation 2 (After June 25, 2024)</h3>
  <label for="grantPrice2">Grant Price per Share ($):</label>
  <input type="number" id="grantPrice2" step="0.01"><br><br>

  <label for="exercisePrice2">Exercise Price per Share ($):</label>
  <input type="number" id="exercisePrice2" step="0.01"><br><br>

  <label for="fmvAtExercise2">Fair Market Value at Exercise ($):</label>
  <input type="number" id="fmvAtExercise2" step="0.01"><br><br>

  <label for="numberOfShares2">Number of Shares:</label>
  <input type="number" id="numberOfShares2"><br><br>

  <label for="employeeContribution2">Employee Contribution ($):</label>
  <input type="number" id="employeeContribution2" step="0.01" value=""><br><br>

  <label for="exerciseDate2">Exercise Date:</label>
  <input type="date" id="exerciseDate2" min="2024-06-26" max="2024-12-31"><br><br>

  <button onclick="calculateT4Values()">Calculate T4 Values</button>

  <h3 class="result">Results:</h3>
  <p id="box14" class="result">Box 14 (Employment Income): $0.00</p>
  <p id="box90" class="result">Box 90 (Security Options Benefits): $0.00</p>
  <p id="box91" class="result">Box 91 (Security Options Deduction): $0.00</p>
  <p id="box38" class="result">Box 38 (Security Options Benefits): $0.00</p>
  <p id="box39" class="result">Box 39 (Security Options Deduction): $0.00</p>

  <script>
     // Define date ranges
     var startDate1 = new Date('2024-01-01');
     var endDate1 = new Date('2024-06-25');
     var startDate2 = new Date('2024-06-26');
     var endDate2 = new Date('2024-12-31');

     function validateDate(date, minDate, maxDate) {
        return date >= minDate && date <= maxDate;
     }

     function getValidatedValue(id) {
        var value = document.getElementById(id).value;
        return value ? parseFloat(value) : 0;
     }

     function validateInputsForSituation1() {
        var dateInput = document.getElementById('exerciseDate1');
        var exerciseDate = new Date(dateInput.value);

        if (!dateInput.value) {
           alert("Exercise Date for Situation 1 is mandatory.");
           dateInput.focus();
           return false;
        }

        if (!validateDate(exerciseDate, startDate1, endDate1)) {
           alert("Exercise Date for Situation 1 must be between " + startDate1.toDateString() + " and " + endDate1.toDateString() + ".");
           dateInput.focus();
           return false;
        }

        return true;
     }

     function validateInputsForSituation2() {
        var dateInput = document.getElementById('exerciseDate2');
        var exerciseDate = new Date(dateInput.value);

        if (!dateInput.value) {
           alert("Exercise Date for Situation 2 is mandatory.");
           dateInput.focus();
           return false;
        }

        if (!validateDate(exerciseDate, startDate2, endDate2)) {
           alert("Exercise Date for Situation 2 must be between " + startDate2.toDateString() + " and " + endDate2.toDateString() + ".");
           dateInput.focus();
           return false;
        }

        return true;
     }

     function calculateForSituation(grantPriceId, exercisePriceId, fmvAtExerciseId, numberOfSharesId, employeeContributionId, exerciseDateId, minDate, maxDate) {
        var grantPrice = getValidatedValue(grantPriceId);
        var exercisePrice = getValidatedValue(exercisePriceId);
        var fmvAtExercise = getValidatedValue(fmvAtExerciseId);
        var numberOfShares = parseInt(getValidatedValue(numberOfSharesId));
        var employeeContribution = getValidatedValue(employeeContributionId);
        var exerciseDate = new Date(document.getElementById(exerciseDateId).value);

        // Calculate the taxable benefit
        var taxableBenefit = ((fmvAtExercise - exercisePrice) * numberOfShares) - employeeContribution;

        // Initialize the amounts
        var box90Amount = 0;
        var box91Amount = 0;
        var box38Amount = 0;
        var box39Amount = 0;

        // Calculate the amounts based on the date ranges
        if (exerciseDate >= minDate && exerciseDate <= maxDate) {
           if (minDate.getTime() === startDate1.getTime()) { // Situation 1
              box90Amount = taxableBenefit; // Code 90 for Situation 1
              box91Amount = 0.5 * taxableBenefit; // Deduction for Situation 1
           } else { // Situation 2
              box38Amount = taxableBenefit; // Code 38 for Situation 2
              box39Amount = (1/3) * taxableBenefit; // Deduction for Situation 2
           }
        }

        return { box90Amount, box91Amount, box38Amount, box39Amount };
     }

     function calculateT4Values() {
        // Hide results initially
        var results = document.querySelectorAll('.result');
        results.forEach(function(element) {
           element.style.display = 'none';
        });

        // Validate inputs and dates for each situation
        var isValidSituation1 = true;
        var isValidSituation2 = true;

        if (document.getElementById('exerciseDate1').value) {
           isValidSituation1 = validateInputsForSituation1();
        }

        if (document.getElementById('exerciseDate2').value) {
           isValidSituation2 = validateInputsForSituation2();
        }

        if (!isValidSituation1 && !isValidSituation2) {
           return; // If any situation is invalid, stop calculation
        }

        // Calculate for the situations
        var result1 = calculateForSituation('grantPrice1', 'exercisePrice1', 'fmvAtExercise1', 'numberOfShares1', 'employeeContribution1', 'exerciseDate1', startDate1, endDate1);
        var result2 = calculateForSituation('grantPrice2', 'exercisePrice2', 'fmvAtExercise2', 'numberOfShares2', 'employeeContribution2', 'exerciseDate2', startDate2, endDate2);

        // Aggregate results
        var totalBox90Amount = result1.box90Amount;
        var totalBox91Amount = result1.box91Amount;
        var totalBox38Amount = result2.box38Amount;
        var totalBox39Amount = result2.box39Amount;

        // Calculate the total taxable benefit
        var totalBox14Amount = totalBox90Amount + totalBox38Amount;

        // Display the results
        document.getElementById('box14').textContent = "Box 14 (Employment Income): $" + totalBox14Amount.toFixed(2);
        document.getElementById('box90').textContent = "Box 90 (Security Options Benefits): $" + totalBox90Amount.toFixed(2);
      

        document.getElementById('box91').textContent = "Box 91 (Security Options Deduction): $" + totalBox91Amount.toFixed(2);
        document.getElementById('box38').textContent = "Box 38 (Security Options Benefits): $" + totalBox38Amount.toFixed(2);
        document.getElementById('box39').textContent = "Box 39 (Security Options Deduction): $" + totalBox39Amount.toFixed(2);

        // Show results after calculation
        results.forEach(function(element) {
           element.style.display = 'block';
        });
     }

     function resetResults() {
        // Hide results
        var results = document.querySelectorAll('.result');
        results.forEach(function(element) {
           element.style.display = 'none';
        });
     }

     // Attach input event listeners to reset results on input change
     document.querySelectorAll('input').forEach(function(input) {
        input.addEventListener('input', function() {
           resetResults();
        });
     });
  </script>
</body>
</html>
